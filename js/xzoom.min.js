(function ($) {
    var defaults = {
        position: 'right',
        mposition: 'inside',
        rootOutput: true,
        Xoffset: 15,
        Yoffset: 0,
        fadeIn: true,
        fadeTrans: true,
        fadeOut: false,
        smooth: true,
        smoothZoomMove: 3,
        smoothLensMove: 1,
        smoothScale: 6,
        defaultScale: 0,
        scroll: true,
        tint: false,
        tintOpacity: 0.5,
        lens: true,
        lensOpacity: 0.5,
        lensShape: 'box',
        zoomWidth: 'auto',
        zoomHeight: 'auto',
        sourceClass: 'xzoom-source',
        loadingClass: 'xzoom-loading',
        lensClass: 'xzoom-lens',
        zoomClass: 'xzoom-preview',
        activeClass: 'xactive',
        hover: false,
        adaptive: true,
        lensReverse: false,
        adaptiveReverse: false,
        title: false,
        titleClass: 'xzoom-caption',
        bg: false
    };

    $.fn.xzoom = function (options) {
        if (this.length === 0) return this;
        if (this.length > 1) {
            this.each(function () { $(this).xzoom(options); });
            return this;
        }

        var api = {};
        var settings = $.extend({}, defaults, options);
        var target = this;
        var source = target.attr('xoriginal') || target.attr('src');
        var preview = $('<div class="' + settings.zoomClass + '"></div>').appendTo('body');
        var lens = $('<div class="' + settings.lensClass + '"></div>').appendTo('body');

        if (settings.lens) {
            lens.css({
                position: 'absolute',
                border: '1px solid #000',
                background: '#fff',
                opacity: settings.lensOpacity,
                cursor: 'crosshair'
            });
        }

        preview.css({
            position: 'absolute',
            border: '1px solid #000',
            background: '#fff',
            visibility: 'hidden',
            'z-index': '9999'
        });

        var imageObject = new Image();
        imageObject.src = source;

        target.on('mouseenter', function (e) {
            var xPos = e.pageX - target.offset().left;
            var yPos = e.pageY - target.offset().top;
            var w = target.width();
            var h = target.height();

            preview.css({
                left: target.offset().left + w + settings.Xoffset,
                top: target.offset().top,
                width: w,
                height: h,
                visibility: 'visible'
            }).html('<img src="' + source + '" style="width:100%;height:100%;">');

            if (settings.lens) {
                var ratio = preview.width() / w;
                lens.css({
                    left: target.offset().left + xPos - 25,
                    top: target.offset().top + yPos - 25,
                    width: 50,
                    height: 50,
                    visibility: 'visible'
                });
            }
        });

        target.on('mousemove', function (e) {
            var xPos = e.pageX - target.offset().left;
            var yPos = e.pageY - target.offset().top;

            if (settings.lens) {
                lens.css({
                    left: target.offset().left + xPos - 25,
                    top: target.offset().top + yPos - 25
                });
            }

            var previewImg = preview.find('img');
            var ratio = preview.width() / target.width();
            previewImg.css({
                'margin-left': -xPos * ratio,
                'margin-top': -yPos * ratio
            });
        });

        target.on('mouseleave', function () {
            lens.css('visibility', 'hidden');
            preview.css('visibility', 'hidden');
        });

        $('.xzoom-gallery').on('click', function (e) {
            e.preventDefault();
            var newSource = $(this).attr('xpreview') || $(this).attr('src');
            target.attr('src', newSource);
            source = $(this).attr('xoriginal') || newSource;
            imageObject.src = source;
        });

        return this;
    };
})(jQuery);